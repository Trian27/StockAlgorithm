{% extends 'stocks/base.html' %}
{% block main_content %}
<title>Stock Portfolio</title>
<h1>Stock Portfolio</h1>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<p>
    <ol>
      {% if stock_dicts %}
        {% for s in stock_dicts %}
          <dialog id="buy_stock_dialog{{s.stock_id}}" selection anchor_node_text class="overflow-hidden bg-transparent">
            <div class="flex justify-center items-center w-screen h-screen bg-transparent">
              <div class="bg-white p-4 rounded-lg w-96 h-96 overflow-auto">
                <h2 class="text-2xl font-bold mb-4">Buy More {{s.stock_id}}</h2>
                  <form id="buy_stock_form{{s.stock_id}}">
                    {% csrf_token %}
                    <span class="bg-white-100 p-2"></span>
                    <div class="mb-4">
                      <label for="num_shares">Number of Shares:</label>
                      <input type="number" id="num_shares" name="num_shares" min="0">
                    </div>
                    <br>
                    <div class="mt-6">
                      <button type="submit" id="buy_stock_submit_button{{s.stock_id}}" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">Place Order</button>
                      <button type="button" onclick="buy_stock_dialog{{s.stock_id}}.close(); $('#buy_stock_form{{s.stock_id}}')[0].reset();" class="bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600">Cancel</button>
                    </div>
                  </form>
              </div>
            </div>
            <script>
              $("dialog").on("submit", "#buy_stock_form{{s.stock_id}}", (evt) => {
                evt.preventDefault();
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const form = document.getElementById('buy_stock_form{{s.stock_id}}');
                const formData = new FormData(form);
                fetch('{% url "stocks:buy_stock" s.stock_id %}', {
                  method: 'POST',
                  headers: {
                      'X-CSRFToken': csrftoken
                  },
                  body: formData,
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                  window.location.reload();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
              })
            </script>
          </dialog>
          <dialog id="sell_stock_dialog{{s.stock_id}}" selection anchor_node_text class="overflow-hidden bg-transparent">
            <div class="flex justify-center items-center w-screen h-screen bg-transparent">
              <div class="bg-white p-4 rounded-lg w-96 h-96 overflow-auto">
                <h2 class="text-2xl font-bold mb-4">Sell {{s.stock_id}}</h2>
                  <form id="sell_stock_form{{s.stock_id}}">
                    {% csrf_token %}
                    <span class="bg-white-100 p-2"></span>
                    <div class="mb-4">
                      <label for="num_shares">Number of Shares:</label>
                      <input type="number" id="num_shares" name="num_shares" min="0" max="{{s.num_shares}}">
                    </div>
                    <br>
                    <div class="mt-6">
                      <button type="submit" id="sell_stock_submit_button{{s.stock_id}}" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">Place Order</button>
                      <button type="button" onclick="sell_stock_dialog{{s.stock_id}}.close(); $('#sell_stock_form{{s.stock_id}}')[0].reset();" class="bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600">Cancel</button>
                    </div>
                  </form>
              </div>
            </div>
            <script>
              $("dialog").on("submit", "#sell_stock_form{{s.stock_id}}", (evt) => {
                evt.preventDefault();
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const form = document.getElementById('sell_stock_form{{s.stock_id}}');
                const formData = new FormData(form);
                fetch('{% url "stocks:sell_stock" s.stock_id %}', {
                  method: 'POST',
                  headers: {
                      'X-CSRFToken': csrftoken
                  },
                  body: formData,
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                  window.location.reload();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
              })
            </script>
          </dialog>
          <li>
            <a href = {% url "stocks:statistics" s.stock_id %}>
              <b>{{ s.ticker }}</b></a>, {{ s.shares }} shares, {{ s.price }} $ per share, {{ s.time }}
              <ul class="flex flex-row mr-4 items-center">
                <li class="nav-item dropdown">
                  <a class="nav-link p-0 active:text-red-300 focus:text-red-300" href="#" id="commentDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-three-dots-vertical text-2xl dark:text-white"></i>
                  </a>
                  <style>
                    .hover-highlight:hover {
                      background-color: lightgray;
                    }
                    .btn-square {
                        border-radius: 0 !important;
                    }
                  </style>
                  <ul class="dropdown-menu dropdown-menu-end py-0" aria-labelledby="commentDropdown">
                    <li>                                    
                      <button type="button" id="buy_stock" class="btn btn-light w-100 hover-highlight btn-square text-sm font-medium hover:text-red-500 mr-3" onclick="buy_stock_dialog{{s.stock_id}}.showModal()" >Buy</button>
                      <button type="button" id="sell_stock" class="btn btn-light w-100 hover-highlight btn-square text-sm font-medium hover:text-red-500 mr-3" onclick="sell_stock_dialog{{s.stock_id}}.showModal()" >Sell</button>
                    </li>
                  </ul>
                </li>
              </ul>
          </li>
        {% endfor %}
      {% else %}
        No stocks in portfolio
      {% endif %}
    </ol>
</p>

<dialog id="track_new_stock_dialog" selection anchor_node_text class="overflow-hidden bg-transparent">
  <div class="flex justify-center items-center w-screen h-screen bg-transparent">
    <div class="bg-white p-4 rounded-lg w-96 h-96 overflow-auto">
      <h2 class="text-2xl font-bold mb-4">Track New Stock</h2>
        <form id="track_new_stock_form">
          {% csrf_token %}
          <span class="bg-white-100 p-2"></span>
          <div class="mb-4">
            <label for="ticker">Ticker:</label>
            <input type="text" id="ticker" name="ticker" maxlength="5" required>
            <label for="num_shares">Number of Shares:</label>
            <input type="number" id="num_shares" name="num_shares" min="0">
          </div>
          <br>
          <div class="mt-6">
            <button type="submit" id="track_new_stock_submit_button" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">Track Stock</button>
            <button type="button" onclick="track_new_stock_dialog.close(); $('#track_new_stock_form')[0].reset();" class="bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600">Cancel</button>
          </div>
        </form>
    </div>
  </div>
  <script>
        $("dialog").on("submit", "#track_new_stock_form", (evt) => {
          evt.preventDefault();
          const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
          const form = document.getElementById('track_new_stock_form');
          const formData = new FormData(form);
          fetch('{% url "stocks:track_new_stock"%}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData,
          })
          .then(response => {
              if (!response.ok) {
                  return response.json().then(data => {
                      throw new Error(data.error);
                  });
              }
              return response.json();
          })
          .then(data => {
            window.location.reload();
          })
          .catch(error => {
              console.error('Error:', error);
          });
        })
  </script>
</dialog>
<button type="button" id="track_new_stock_button" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600" onclick="track_new_stock_dialog.showModal()">Track New Stock</button>

{% endblock %}
<!-- how would I use the base in this case?-->